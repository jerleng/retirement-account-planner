<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
<meta name="color-scheme" content="light only">
<title>Retirement Account Planner</title>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{color-scheme:light only}
html,body{background-color:#faf8f6;color:#111;font-family:'DM Sans',system-ui,-apple-system,BlinkMacSystemFont,sans-serif;font-size:15px;-webkit-text-size-adjust:100%;line-height:1.6;min-height:100vh}
h1,h2,h3,h4{font-family:'Fraunces',Georgia,serif;font-weight:500;line-height:1.3;color:#111}
input,select,button{font-family:inherit;font-size:inherit;color:#111}
.ctr{max-width:1100px;margin:0 auto;padding:0 20px}
.card{background-color:#fff;border-radius:10px;border:1px solid #ddd9d3;padding:24px;margin-bottom:16px;box-shadow:0 1px 3px rgba(0,0,0,.08)}
.card-hdr{display:-webkit-flex;display:flex;-webkit-align-items:center;align-items:center;-webkit-justify-content:space-between;justify-content:space-between;margin-bottom:16px;-webkit-flex-wrap:wrap;flex-wrap:wrap}
.card-hdr>*{margin:4px}
.card h2{font-size:1.25rem;color:#111}.card h3{font-size:1.05rem;margin-bottom:8px;color:#111}
.badge{display:inline-block;padding:2px 10px;border-radius:20px;font-size:.75rem;font-weight:600}
.bg{background-color:#e6f5ed;color:#257a45}.ba{background-color:#fdf3e6;color:#b07a2e}.br{background-color:#fce8e6;color:#c0392b}.bb{background-color:#e6f0f7;color:#2c6e8a}
.btn{display:-webkit-inline-flex;display:inline-flex;-webkit-align-items:center;align-items:center;-webkit-justify-content:center;justify-content:center;padding:10px 22px;border-radius:10px;font-weight:600;font-size:.9rem;cursor:pointer;border:none}
.btn1{background-color:#2d5a3d;color:#fff}.btn2{background-color:#fff;color:#111;border:1px solid #ddd9d3}
.btns{padding:6px 14px;font-size:.8rem}
.fg{margin-bottom:14px}
.fl{display:block;font-size:.8rem;font-weight:600;color:#444;margin-bottom:4px;text-transform:uppercase;letter-spacing:.04em}
.fi{width:100%;padding:9px 12px;border:1px solid #ddd9d3;border-radius:8px;background-color:#fff;color:#111;font-size:.95rem;-webkit-appearance:none}
.fi:focus{outline:none;border-color:#2d5a3d;box-shadow:0 0 0 3px rgba(45,90,61,.1)}
.fr{display:grid;grid-template-columns:1fr 1fr;grid-gap:12px}
select.fi{background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23444' d='M6 8L1 3h10z'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 12px center;padding-right:32px}
.tw{overflow-x:auto;-webkit-overflow-scrolling:touch;margin:0 -24px;padding:0 24px}
table{width:100%;border-collapse:collapse;font-size:.85rem}
th{text-align:left;padding:8px 10px;font-weight:600;color:#444;border-bottom:2px solid #ddd9d3;font-size:.75rem;text-transform:uppercase;letter-spacing:.04em;white-space:nowrap}
td{padding:8px 10px;border-bottom:1px solid #ddd9d3;white-space:nowrap;color:#111}
tr:last-child td{border-bottom:none}
.tr{text-align:right}.tc{text-align:center}.tg{color:#257a45}.trd{color:#c0392b}.ta{color:#b07a2e}.ts{font-size:.8rem}
.g2{display:grid;grid-template-columns:1fr 1fr;grid-gap:16px}
.g3{display:grid;grid-template-columns:1fr 1fr 1fr;grid-gap:16px}
.g4{display:grid;grid-template-columns:repeat(4,1fr);grid-gap:12px}
.sc{background-color:#f4f2ef;border-radius:8px;padding:14px 16px;border:1px solid #ddd9d3}
.sl{font-size:.72rem;font-weight:600;color:#777;text-transform:uppercase;letter-spacing:.05em}
.sv{font-family:'Fraunces',serif;font-size:1.4rem;font-weight:500;margin-top:2px;color:#111}
.ch{cursor:pointer;padding:10px 0;font-weight:600;font-size:.95rem;-webkit-user-select:none;user-select:none;display:-webkit-flex;display:flex;-webkit-align-items:center;align-items:center;color:#111;border-bottom:1px solid #ddd9d3;margin-bottom:8px}
.ch>*{margin-right:8px}
.ca{font-size:.7rem;display:inline-block;-webkit-transition:-webkit-transform .2s;transition:transform .2s}
.cao{-webkit-transform:rotate(90deg);transform:rotate(90deg)}
.cb{padding:8px 0 16px 0;font-size:.88rem;color:#444;line-height:1.7}
.mo{position:fixed;top:0;left:0;right:0;bottom:0;background-color:rgba(0,0,0,.5);display:-webkit-flex;display:flex;-webkit-align-items:center;align-items:center;-webkit-justify-content:center;justify-content:center;z-index:1000;padding:20px}
.mc{background-color:#fff;border-radius:10px;max-width:600px;width:100%;max-height:85vh;overflow-y:auto;box-shadow:0 4px 16px rgba(0,0,0,.1);padding:28px}
.ec{display:-webkit-inline-flex;display:inline-flex;-webkit-align-items:center;align-items:center;padding:4px 10px;border-radius:6px;font-size:.78rem;font-weight:600;cursor:pointer;border:1px solid #ddd9d3;background-color:#fff;margin:2px}
.stabs{display:-webkit-flex;display:flex;background-color:#f4f2ef;border-radius:8px;padding:3px;border:1px solid #ddd9d3;-webkit-flex-wrap:wrap;flex-wrap:wrap}
.stabs>*{margin:2px}
.stab{padding:6px 14px;border-radius:6px;font-size:.8rem;font-weight:600;cursor:pointer;border:none;background-color:transparent;color:#777}
.stab.act{background-color:#fff;color:#111;box-shadow:0 1px 3px rgba(0,0,0,.08)}
.is{display:-webkit-flex;display:flex;-webkit-align-items:flex-end;align-items:flex-end;margin-bottom:10px;padding:10px 12px;background-color:#f4f2ef;border-radius:8px;border:1px solid #ddd9d3;-webkit-flex-wrap:wrap;flex-wrap:wrap}
.is>*{margin:4px}
.if{display:grid;grid-template-columns:2fr 1fr 1fr 1fr;grid-gap:8px;-webkit-flex:1;flex:1;min-width:0}
.hero{text-align:center;padding:48px 20px 32px}
.hero h1{font-size:2.2rem;margin-bottom:8px;color:#111}
.hero p{color:#444;font-size:1rem;max-width:520px;margin:0 auto}
.ha{color:#2d5a3d}
.dv{height:1px;background-color:#ddd9d3;margin:20px 0}
.ab{margin-top:16px;padding:12px 16px;border-radius:8px}
.abd{background-color:#fce8e6;border:1px solid #f5c6c2}
.abs{background-color:#e6f5ed;border:1px solid #b6e3c8}
.rg{display:grid;grid-template-columns:1fr 1fr;grid-gap:16px;margin-top:8px}
.sell{color:#c0392b;font-weight:600}
.buy{color:#257a45;font-weight:600}
#load-msg{text-align:center;padding:60px 20px;font-family:system-ui,sans-serif;color:#444}
#load-msg h2{color:#111;margin-bottom:12px}
@media(prefers-color-scheme:dark){
  html,body{background-color:#faf8f6 !important;color:#111 !important}
  *{color:inherit !important}
  .card,.mc,.fi,.btn2,.ec,.stab.act,.is{background-color:#fff !important}
  .sc{background-color:#f4f2ef !important}
  .stabs{background-color:#f4f2ef !important}
  .hero,.cb{background-color:transparent !important}
  input,select{background-color:#fff !important;color:#111 !important}
  td,th{color:#111 !important}
}
@media(max-width:768px){
  .fr,.g2,.g3,.g4,.rg,.if{grid-template-columns:1fr}
  .hero h1{font-size:1.6rem}.hero{padding:32px 10px 20px}
  .card{padding:16px}.sv{font-size:1.15rem}.ctr{padding:0 12px}
  table{font-size:.78rem}td,th{padding:6px}
  .tw{margin:0 -16px;padding:0 16px}
}
@media print{.np{display:none !important}}
</style>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700&family=Fraunces:opsz,wght@9..144,300;9..144,500;9..144,700&display=swap" rel="stylesheet">
</head>
<body>
<div id="root">
<div id="load-msg">
<h2>Retirement Account Planner</h2>
<p>Loading application...</p>
<p style="margin-top:20px;font-size:13px;color:#999" id="load-status">Loading React...</p>
</div>
</div>

<script>
/* Error handler - registered BEFORE anything else */
window.onerror = function(msg, src, line, col, err) {
  var el = document.getElementById("root");
  if (el) {
    el.innerHTML = "<div style='padding:32px;font-family:system-ui,sans-serif;color:#111;background:#faf8f6;max-width:600px;margin:20px auto'>" +
      "<h2 style='color:#c0392b;margin-bottom:12px'>Application Error</h2>" +
      "<p style='margin-bottom:8px;word-break:break-word'>" + String(msg) + "</p>" +
      "<p style='color:#777;font-size:13px'>Line: " + String(line) + "</p>" +
      "<p style='margin-top:16px'>Try: 1) Refresh the page 2) Clear browser cache 3) Disable content blockers</p></div>";
  }
  return true;
};
</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>

<script>
if(typeof React==="undefined"){
  var s=document.getElementById("load-status");
  if(s)s.innerHTML="<span style='color:#c0392b'>Failed to load React. Check your internet connection or disable content blockers.</span>";
}
</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>

<script>
/* ============================================================
   RETIREMENT ACCOUNT PLANNER - Main Application
   Only runs if React + ReactDOM + Chart.js loaded successfully
   ============================================================ */
(function() {
  "use strict";

  /* --- Dependency Check --- */
  if (typeof React === "undefined" || typeof ReactDOM === "undefined") {
    var el = document.getElementById("root");
    if (el) el.innerHTML = "<div style='padding:40px;text-align:center;font-family:system-ui,sans-serif'>" +
      "<h2 style='color:#c0392b'>Failed to Load</h2>" +
      "<p style='color:#444;margin:12px 0'>Required libraries could not be loaded.</p>" +
      "<p style='color:#777;font-size:13px'>This may be caused by: a content blocker, network issue, or firewall.</p>" +
      "<p style='margin-top:16px'><a href='javascript:location.reload()' style='color:#2d5a3d;font-weight:600'>Reload Page</a></p></div>";
    return;
  }

  var useState = React.useState;
  var useEffect = React.useEffect;
  var useMemo = React.useMemo;
  var useRef = React.useRef;
  var h = React.createElement;

  var STORE_KEY = "retirewise_v3";
  function saveInputs(inp) { try { localStorage.setItem(STORE_KEY, JSON.stringify(inp)); } catch (e) { } }
  function loadInputs() { try { var s = localStorage.getItem(STORE_KEY); return s ? JSON.parse(s) : null; } catch (e) { return null; } }

  var ETFS = {
    VUG: { t: "VUG", nm: "Vanguard Growth ETF", cat: "US Large Growth", er: .04, dy: .5, strat: "Large-cap growth companies.", hold: ["Apple", "Microsoft", "NVIDIA", "Amazon", "Meta"], ret: { y1: 32.5, y3: 10.1, y5: 18.2, y10: 15.8 }, risk: "Moderate-High", avg: 12.5, sd: 18.2, best: 40.2, worst: -33.3 },
    QQQ: { t: "QQQ", nm: "Invesco QQQ Trust", cat: "US Tech/Growth", er: .20, dy: .6, strat: "Concentrated tech exposure.", hold: ["Apple", "Microsoft", "NVIDIA", "Amazon", "Broadcom"], ret: { y1: 28.7, y3: 11.5, y5: 19.8, y10: 17.9 }, risk: "High", avg: 13.8, sd: 20.1, best: 54.7, worst: -32.6 },
    SCHG: { t: "SCHG", nm: "Schwab U.S. Large-Cap Growth ETF", cat: "US Large Growth", er: .04, dy: .4, strat: "Low-cost large-cap growth.", hold: ["Apple", "Microsoft", "NVIDIA", "Amazon", "Meta"], ret: { y1: 33.1, y3: 10.8, y5: 19.0, y10: 16.2 }, risk: "Moderate-High", avg: 12.8, sd: 18.5, best: 41.5, worst: -34.1 },
    VTV: { t: "VTV", nm: "Vanguard Value ETF", cat: "US Large Value", er: .04, dy: 2.3, strat: "Undervalued large-caps for stability and income.", hold: ["Berkshire", "JPMorgan", "UnitedHealth", "ExxonMobil", "P&G"], ret: { y1: 19.8, y3: 8.2, y5: 10.5, y10: 9.8 }, risk: "Moderate", avg: 9.2, sd: 13.8, best: 30.1, worst: -35.9 },
    SCHD: { t: "SCHD", nm: "Schwab U.S. Dividend Equity ETF", cat: "Dividend", er: .06, dy: 3.4, strat: "Quality companies with 10+ year dividend history.", hold: ["Coca-Cola", "Verizon", "PepsiCo", "Home Depot", "Cisco"], ret: { y1: 12.5, y3: 6.8, y5: 11.8, y10: 11.2 }, risk: "Low-Moderate", avg: 10.5, sd: 12.8, best: 29.9, worst: -20.5 },
    VYM: { t: "VYM", nm: "Vanguard High Dividend Yield ETF", cat: "Dividend", er: .06, dy: 2.8, strat: "Broad high-dividend exposure.", hold: ["Broadcom", "JPMorgan", "ExxonMobil", "P&G", "Home Depot"], ret: { y1: 18.2, y3: 7.5, y5: 10.2, y10: 9.6 }, risk: "Low-Moderate", avg: 9.0, sd: 13.2, best: 28.5, worst: -26.1 },
    VXUS: { t: "VXUS", nm: "Vanguard Total Intl Stock ETF", cat: "International", er: .07, dy: 3.0, strat: "7,000+ stocks in 40+ countries.", hold: ["Taiwan Semi", "Novo Nordisk", "Samsung", "ASML", "Nestle"], ret: { y1: 9.8, y3: 3.1, y5: 6.2, y10: 5.1 }, risk: "Moderate-High", avg: 6.0, sd: 16.5, best: 27.5, worst: -41.2 },
    BND: { t: "BND", nm: "Vanguard Total Bond Market ETF", cat: "US Bonds", er: .03, dy: 4.3, strat: "Core fixed income ballast.", hold: ["US Treasuries", "Agency Bonds", "Corp Bonds"], ret: { y1: 1.3, y3: -2.1, y5: .3, y10: 1.5 }, risk: "Low", avg: 3.2, sd: 5.5, best: 8.7, worst: -13.0 },
    TIP: { t: "TIP", nm: "iShares TIPS Bond ETF", cat: "Inflation Protected", er: .19, dy: 4.8, strat: "Inflation protection via TIPS.", hold: ["TIPS various maturities"], ret: { y1: 1.8, y3: -.5, y5: 2.8, y10: 2.2 }, risk: "Low", avg: 3.0, sd: 6.2, best: 11.4, worst: -11.8 },
    VGSH: { t: "VGSH", nm: "Vanguard Short-Term Treasury ETF", cat: "Short-Term Bonds", er: .04, dy: 4.5, strat: "Ultra-low duration treasuries.", hold: ["US Treasury Notes 1-3yr"], ret: { y1: 3.8, y3: 1.2, y5: 1.8, y10: 1.4 }, risk: "Very Low", avg: 2.2, sd: 2.1, best: 5.8, worst: -3.8 },
    SHV: { t: "SHV", nm: "iShares Short Treasury Bond ETF", cat: "Cash Equivalent", er: .15, dy: 5.0, strat: "Near-cash minimal risk.", hold: ["US T-Bills under 1yr"], ret: { y1: 5.2, y3: 3.5, y5: 2.5, y10: 1.6 }, risk: "Very Low", avg: 1.8, sd: .8, best: 5.2, worst: 0.0 },
    VNQ: { t: "VNQ", nm: "Vanguard Real Estate ETF", cat: "REITs", er: .12, dy: 3.8, strat: "REITs for income and inflation hedge.", hold: ["Prologis", "American Tower", "Equinix", "Welltower", "Simon Property"], ret: { y1: 8.5, y3: 2.1, y5: 5.8, y10: 6.5 }, risk: "Moderate-High", avg: 8.0, sd: 19.5, best: 37.1, worst: -37.0 }
  };
  var EC = { VUG: "#8b5cf6", QQQ: "#ec4899", SCHG: "#a855f7", VTV: "#6366f1", SCHD: "#10b981", VYM: "#14b8a6", VXUS: "#f59e0b", BND: "#64748b", TIP: "#0ea5e9", VGSH: "#06b6d4", SHV: "#84cc16", VNQ: "#f97316" };

  var ST = { AL: { n: "Alabama", r: 4.4 }, AK: { n: "Alaska", r: 0 }, AZ: { n: "Arizona", r: 2.5 }, AR: { n: "Arkansas", r: 4.4 }, CA: { n: "California", r: 9.3 }, CO: { n: "Colorado", r: 4.4 }, CT: { n: "Connecticut", r: 5 }, DE: { n: "Delaware", r: 5.5 }, FL: { n: "Florida", r: 0 }, GA: { n: "Georgia", r: 5.39 }, HI: { n: "Hawaii", r: 7.2 }, ID: { n: "Idaho", r: 5.8 }, IL: { n: "Illinois", r: 4.95 }, IN: { n: "Indiana", r: 3.05 }, IA: { n: "Iowa", r: 5.7 }, KS: { n: "Kansas", r: 5.2 }, KY: { n: "Kentucky", r: 4 }, LA: { n: "Louisiana", r: 3.5 }, ME: { n: "Maine", r: 6.75 }, MD: { n: "Maryland", r: 5 }, MA: { n: "Massachusetts", r: 5 }, MI: { n: "Michigan", r: 4.25 }, MN: { n: "Minnesota", r: 7.05 }, MS: { n: "Mississippi", r: 4.7 }, MO: { n: "Missouri", r: 4.8 }, MT: { n: "Montana", r: 5.9 }, NE: { n: "Nebraska", r: 5.84 }, NV: { n: "Nevada", r: 0 }, NH: { n: "New Hampshire", r: 0 }, NJ: { n: "New Jersey", r: 6.37 }, NM: { n: "New Mexico", r: 4.9 }, NY: { n: "New York", r: 6.85 }, NC: { n: "N. Carolina", r: 4.5 }, ND: { n: "N. Dakota", r: 1.95 }, OH: { n: "Ohio", r: 3.5 }, OK: { n: "Oklahoma", r: 4.75 }, OR: { n: "Oregon", r: 8.75 }, PA: { n: "Pennsylvania", r: 3.07 }, RI: { n: "Rhode Island", r: 5 }, SC: { n: "S. Carolina", r: 6.2 }, SD: { n: "S. Dakota", r: 0 }, TN: { n: "Tennessee", r: 0 }, TX: { n: "Texas", r: 0 }, UT: { n: "Utah", r: 4.65 }, VT: { n: "Vermont", r: 6.6 }, VA: { n: "Virginia", r: 5 }, WA: { n: "Washington", r: 0 }, WV: { n: "W. Virginia", r: 5.12 }, WI: { n: "Wisconsin", r: 5.7 }, WY: { n: "Wyoming", r: 0 }, DC: { n: "D.C.", r: 8.5 } };

  var FB = [{ m: 11600, r: 10 }, { m: 47150, r: 12 }, { m: 100525, r: 22 }, { m: 191950, r: 24 }, { m: 243725, r: 32 }, { m: 609350, r: 35 }, { m: 1e15, r: 37 }];
  var FM = [{ m: 23200, r: 10 }, { m: 94300, r: 12 }, { m: 201050, r: 22 }, { m: 383900, r: 24 }, { m: 487450, r: 32 }, { m: 731200, r: 35 }, { m: 1e15, r: 37 }];
  var LIQ = ["SHV", "VGSH", "BND", "TIP", "VYM", "SCHD", "VTV", "VNQ", "VXUS", "VUG", "SCHG", "QQQ"];
  var INF = 0.028;

  function fmt(n) {
    if (n == null || isNaN(n)) return "$0";
    var a = Math.abs(n);
    if (a >= 1e6) return (n < 0 ? "-" : "") + "$" + (a / 1e6).toFixed(1) + "M";
    return (n < 0 ? "-$" : "$") + Math.round(a).toLocaleString("en-US");
  }
  function fedTax(inc, mfj) {
    var b = mfj ? FM : FB; var d = mfj ? 29200 : 14600; var tx = Math.max(0, inc - d); var t = 0; var p = 0;
    for (var i = 0; i < b.length; i++) { if (tx > p) t += (Math.min(tx, b[i].m) - p) * b[i].r / 100; p = b[i].m; }
    return t;
  }
  function lifeExp(a) { if (a <= 40) return 82; if (a <= 50) return 83; if (a <= 60) return 84; if (a <= 65) return 85; if (a <= 70) return 86; if (a <= 75) return 87; if (a <= 80) return 89; return 92; }
  function glidePath(yi, total, startAge) {
    var ca = (startAge || 55) + yi;
    var aw = Math.min(1, Math.max(0, (ca - 40) / 45));
    var pw = total <= 1 ? 1 : yi / (total - 1);
    var t = Math.min(1, Math.max(0, aw * 0.6 + pw * 0.4));
    var r = { growth: Math.max(0, 0.35 * (1 - t * 1.3)), value: 0.08 + 0.12 * t, dividend: 0.08 + 0.22 * t, intl: Math.max(0.02, 0.15 * (1 - t * 0.8)), reit: Math.max(0.02, 0.08 * (1 - t * 0.5)), bond: 0.10 + 0.18 * t, tips: 0.03 + 0.05 * t, shortBond: 0.04 + 0.14 * t, cash: 0.03 + 0.12 * t };
    var s = 0; var k = Object.keys(r); for (var i = 0; i < k.length; i++) s += r[k[i]];
    var n = {}; for (var i = 0; i < k.length; i++) n[k[i]] = r[k[i]] / s; return n;
  }
  function a2e(a) { return { VUG: a.growth * 0.5, QQQ: a.growth * 0.3, SCHG: a.growth * 0.2, VTV: a.value, SCHD: a.dividend * 0.6, VYM: a.dividend * 0.4, VXUS: a.intl, VNQ: a.reit, BND: a.bond, TIP: a.tips, VGSH: a.shortBond, SHV: a.cash }; }
  function sRet(tk, sc, yi) {
    var e = ETFS[tk]; if (!e) return 0;
    var b = e.avg / 100; var sd = e.sd / 100;
    if (sc === "best") return b + sd * 0.65;
    if (sc === "worst") return b - sd * 0.55;
    if (sc === "recession") { if (yi === 0) return b - sd * 1.4; if (yi === 1) return b - sd * 0.6; if (yi === 2) return b + sd * 0.4; return b; }
    return b;
  }

  function calcPlan(inp) {
    var results = {};
    var scenarios = ["average", "best", "worst", "recession"];
    for (var si = 0; si < scenarios.length; si++) {
      var sc = scenarios[si];
      var port = inp.initialPortfolio;
      var yd = [];
      for (var y = 0; y < inp.horizon; y++) {
        var ca = inp.age + y;
        var im = Math.pow(1 + INF, y);
        var ae = inp.monthlyExpenses * 12 * im;
        var ss = ca >= inp.ssAge ? inp.ssMonthly * 12 * Math.pow(1.02, Math.max(0, ca - inp.ssAge)) : 0;
        var ei = 0;
        for (var xi = 0; xi < inp.extraIncomes.length; xi++) {
          var src = inp.extraIncomes[xi];
          if (ca >= src.startAge && ca <= src.endAge) ei += src.monthly * 12 * im;
        }
        var al = glidePath(y, inp.horizon, inp.age);
        var ea = a2e(al);
        var ek = Object.keys(ea);
        var wr = 0; var dyw = 0;
        for (var ki = 0; ki < ek.length; ki++) {
          wr += ea[ek[ki]] * sRet(ek[ki], sc, y);
          dyw += ea[ek[ki]] * (ETFS[ek[ki]] ? ETFS[ek[ki]].dy : 0) / 100;
        }
        var di = port * dyw;
        var pg = port * (wr - dyw);
        var totalIncome = ss + ei + di;

        /* TAX PASS 1: tax on non-withdrawal income */
        var taxableBase = ei;
        if (inp.accountType === "traditional") { taxableBase += di; }
        else if (inp.accountType === "taxable") { taxableBase += di * 0.7; }
        var combined1 = taxableBase + ss * 0.5;
        var ssTh = inp.filing === "married" ? 32000 : 25000;
        var ssTh2 = inp.filing === "married" ? 44000 : 34000;
        var ssTaxable1 = 0;
        if (combined1 > ssTh2) { ssTaxable1 = Math.min(ss * 0.85, (combined1 - ssTh2) * 0.85); }
        else if (combined1 > ssTh) { ssTaxable1 = Math.min(ss * 0.5, (combined1 - ssTh) * 0.5); }
        taxableBase += ssTaxable1;
        var baseFed = Math.round(fedTax(taxableBase, inp.filing === "married"));
        var baseSt = Math.round(taxableBase * (ST[inp.state] ? ST[inp.state].r : 0) / 100);
        var baseTax = baseFed + baseSt;

        var surplus = totalIncome - ae;
        var actualWithdrawal = 0;
        var fedT = baseFed;
        var stT = baseSt;
        var totalTax = baseTax;

        if (surplus < baseTax) {
          var expenseShortfall = Math.max(0, -surplus);
          var rawNeed = expenseShortfall + Math.max(0, baseTax - Math.max(0, surplus));
          if (inp.accountType === "traditional" && rawNeed > 0) {
            var adjTaxable = taxableBase - ssTaxable1 + rawNeed;
            var combined2 = adjTaxable + ss * 0.5;
            var ssTaxable2 = 0;
            if (combined2 > ssTh2) { ssTaxable2 = Math.min(ss * 0.85, (combined2 - ssTh2) * 0.85); }
            else if (combined2 > ssTh) { ssTaxable2 = Math.min(ss * 0.5, (combined2 - ssTh) * 0.5); }
            adjTaxable += ssTaxable2;
            fedT = Math.round(fedTax(adjTaxable, inp.filing === "married"));
            stT = Math.round(adjTaxable * (ST[inp.state] ? ST[inp.state].r : 0) / 100);
            totalTax = fedT + stT;
            rawNeed = expenseShortfall + Math.max(0, totalTax - Math.max(0, surplus));
          } else if (inp.accountType === "taxable" && rawNeed > 0) {
            var adjTaxable2 = taxableBase + rawNeed * 0.5;
            fedT = Math.round(fedTax(adjTaxable2, inp.filing === "married"));
            stT = Math.round(adjTaxable2 * (ST[inp.state] ? ST[inp.state].r : 0) / 100);
            totalTax = fedT + stT;
            rawNeed = expenseShortfall + Math.max(0, totalTax - Math.max(0, surplus));
          }
          var portAfterGrowth = port + pg;
          actualWithdrawal = Math.min(rawNeed, Math.max(0, portAfterGrowth));
        }

        var portAfterGrowth2 = port + pg;
        port = Math.max(0, portAfterGrowth2 - actualWithdrawal);
        var netVal = Math.round(di + actualWithdrawal + ss + ei - ae - totalTax);

        yd.push({ yr: y + 1, age: ca, port: Math.round(port), exp: Math.round(ae), ss: Math.round(ss), div: Math.round(di), extra: Math.round(ei), totInc: Math.round(totalIncome), wd: Math.round(actualWithdrawal), fTax: fedT, sTax: stT, tTax: totalTax, net: netVal, alloc: al, ea: ea, wr: wr });
      }
      results[sc] = yd;
    }
    var txns = [];
    for (var y = 0; y < inp.horizon; y++) {
      var ea = a2e(glidePath(y, inp.horizon, inp.age));
      var prevEa = y > 0 ? a2e(glidePath(y - 1, inp.horizon, inp.age)) : null;
      var portAtYear = y === 0 ? inp.initialPortfolio : (results.average[y - 1] ? results.average[y - 1].port : 0);
      if (portAtYear <= 0) continue;
      var row = { yr: y + 1, age: inp.age + y, actions: [] };
      var ek = Object.keys(ea);
      for (var ki = 0; ki < ek.length; ki++) {
        var k = ek[ki];
        if (ea[k] < 0.005 && (!prevEa || prevEa[k] < 0.005)) continue;
        var curPct = ea[k] * 100;
        var prevPct = prevEa ? prevEa[k] * 100 : 0;
        var diff = curPct - prevPct;
        var dollarAmt = Math.round(portAtYear * Math.abs(diff) / 100);
        if (y === 0) {
          row.actions.push({ tk: k, type: "buy", pct: curPct, amt: Math.round(portAtYear * ea[k]) });
        } else if (Math.abs(diff) >= 0.3 && dollarAmt >= 100) {
          row.actions.push({ tk: k, type: diff > 0 ? "buy" : "sell", pct: Math.abs(diff), amt: dollarAmt });
        }
      }
      row.actions.sort(function (a, b) { return b.amt - a.amt; });
      if (row.actions.length > 0) txns.push(row);
    }
    var ia = glidePath(0, inp.horizon, inp.age);
    return { results: results, ia: ia, ie: a2e(ia), horizon: inp.horizon, inputs: inp, txns: txns };
  }

  /* --- Chart Wrapper --- */
  function CC(props) {
    var cr = useRef(null); var ci = useRef(null);
    useEffect(function () {
      if (!cr.current || typeof Chart === "undefined") return;
      if (ci.current) { ci.current.destroy(); }
      ci.current = new Chart(cr.current.getContext("2d"), props.cfg);
      return function () { if (ci.current) { ci.current.destroy(); ci.current = null; } };
    }, [JSON.stringify(props.cfg)]);
    return h("div", { style: { position: "relative", width: "100%", height: props.ht || 300 } }, h("canvas", { ref: cr }));
  }

  /* --- Collapsible --- */
  function Coll(props) {
    var st = useState(props.open || false); var o = st[0]; var so = st[1];
    return h("div", { style: { marginBottom: 8 } },
      h("div", { className: "ch", onClick: function () { so(!o); } },
        h("span", { className: "ca" + (o ? " cao" : "") }, "\u25B6"),
        h("span", { style: { flex: 1 } }, props.title)),
      o ? h("div", { className: "cb" }, props.children) : null);
  }

  /* --- ETF Modal --- */
  function EModal(props) {
    var e = ETFS[props.tk]; if (!e) return null;
    var rc = { "Very Low": "#257a45", "Low": "#257a45", "Low-Moderate": "#2c6e8a", "Moderate": "#b07a2e", "Moderate-High": "#c0392b", "High": "#c0392b" };
    var rbc = { "Very Low": "bg", "Low": "bg", "Low-Moderate": "bb", "Moderate": "ba", "Moderate-High": "br", "High": "br" };
    return h("div", { className: "mo", onClick: props.onClose },
      h("div", { className: "mc", onClick: function (ev) { ev.stopPropagation(); } },
        h("button", { style: { float: "right", background: "none", border: "none", fontSize: "1.5rem", cursor: "pointer", color: "#777", padding: "4px" }, onClick: props.onClose }, "\u00D7"),
        h("div", { style: { display: "flex", alignItems: "center", marginBottom: 16 } },
          h("div", { style: { width: 48, height: 48, borderRadius: 10, backgroundColor: EC[props.tk] || "#888", display: "flex", alignItems: "center", justifyContent: "center", color: "#fff", fontWeight: 700, fontSize: ".85rem", marginRight: 12, flexShrink: 0 } }, props.tk),
          h("div", null, h("h2", { style: { fontSize: "1.2rem", margin: 0 } }, e.nm), h("span", { className: "badge bb" }, e.cat))),
        h("p", { style: { color: "#444", marginBottom: 16, fontSize: ".9rem" } }, e.strat),
        h("div", { className: "g2", style: { marginBottom: 16 } },
          h("div", { className: "sc" }, h("div", { className: "sl" }, "Expense Ratio"), h("div", { className: "sv" }, e.er.toFixed(2) + "%")),
          h("div", { className: "sc" }, h("div", { className: "sl" }, "Dividend Yield"), h("div", { className: "sv" }, e.dy.toFixed(1) + "%")),
          h("div", { className: "sc" }, h("div", { className: "sl" }, "Risk Level"), h("div", { className: "sv", style: { color: rc[e.risk] || "#444", fontSize: "1.1rem" } }, e.risk)),
          h("div", { className: "sc" }, h("div", { className: "sl" }, "Avg Annual Return"), h("div", { className: "sv tg" }, e.avg + "%"))),
        h("h3", null, "Historical Returns"),
        h("div", { className: "tw", style: { marginTop: 8 } }, h("table", null,
          h("thead", null, h("tr", null, h("th", null, "1Y"), h("th", null, "3Y"), h("th", null, "5Y"), h("th", null, "10Y"), h("th", null, "Best"), h("th", null, "Worst"))),
          h("tbody", null, h("tr", null,
            h("td", { className: e.ret.y1 >= 0 ? "tg" : "trd" }, (e.ret.y1 > 0 ? "+" : "") + e.ret.y1 + "%"),
            h("td", { className: e.ret.y3 >= 0 ? "tg" : "trd" }, (e.ret.y3 > 0 ? "+" : "") + e.ret.y3 + "%"),
            h("td", { className: e.ret.y5 >= 0 ? "tg" : "trd" }, (e.ret.y5 > 0 ? "+" : "") + e.ret.y5 + "%"),
            h("td", { className: e.ret.y10 >= 0 ? "tg" : "trd" }, (e.ret.y10 > 0 ? "+" : "") + e.ret.y10 + "%"),
            h("td", { className: "tg" }, "+" + e.best + "%"), h("td", { className: "trd" }, e.worst + "%"))))),
        h("h3", { style: { marginTop: 16 } }, "Top Holdings"),
        h("div", { style: { display: "flex", flexWrap: "wrap", marginTop: 8 } }, e.hold.map(function (x, i) { return h("span", { key: i, style: { display: "inline-block", padding: "1px 8px", borderRadius: 4, fontSize: ".7rem", fontWeight: 600, backgroundColor: "#f4f2ef", border: "1px solid #ddd9d3", margin: 3 } }, x); }))));
  }

  /* --- Input Form --- */
  function IForm(props) {
    var saved = loadInputs(); var d = saved || {};
    var _a = useState(d.age != null ? d.age : 55); var age = _a[0]; var sA = _a[1];
    var _h = useState(d.hor != null ? String(d.hor) : ""); var hor = _h[0]; var sH = _h[1];
    var _e = useState(d.monthlyExpenses != null ? d.monthlyExpenses : 5000); var mExp = _e[0]; var sE = _e[1];
    var _st = useState(d.state || "TX"); var state = _st[0]; var sSt = _st[1];
    var _sa = useState(d.ssAge != null ? d.ssAge : 67); var ssA = _sa[0]; var sSA = _sa[1];
    var _sm = useState(d.ssMonthly != null ? d.ssMonthly : 2500); var ssM = _sm[0]; var sSM = _sm[1];
    var _l = useState(d.desiredLegacy != null ? d.desiredLegacy : 0); var leg = _l[0]; var sL = _l[1];
    var _at = useState(d.accountType || "traditional"); var acct = _at[0]; var sAT = _at[1];
    var _f = useState(d.filing || "single"); var fil = _f[0]; var sF = _f[1];
    var _p = useState(d.initialPortfolio != null ? d.initialPortfolio : 800000); var port = _p[0]; var sP = _p[1];
    var _ei = useState(d.extraIncomes || []); var exs = _ei[0]; var sEI = _ei[1];
    var _ran = useState(false); var autoRan = _ran[0]; var setAutoRan = _ran[1];
    var parsedHor = hor ? (parseInt(hor, 10) || 0) : 0;
    var cH = parsedHor > 0 ? parsedHor : lifeExp(age) - age;

    useEffect(function () { if (!autoRan) { setAutoRan(true); go(true); } }, []);

    function addE() { sEI(exs.concat([{ monthly: 1000, startAge: age, endAge: age + 5, label: "Extra Income" }])); }
    function rmE(i) { sEI(exs.filter(function (_, j) { return j !== i; })); }
    function upE(i, k, v) { var c = exs.slice(); c[i] = Object.assign({}, c[i]); c[i][k] = k === "label" ? v : (Number(v) || 0); sEI(c); }

    function go(silent) {
      if (age < 25 || age > 90) { if (!silent) alert("Age must be 25-90"); return; }
      if (port < 0) { if (!silent) alert("Portfolio cannot be negative"); return; }
      if (mExp <= 0) { if (!silent) alert("Enter monthly expenses"); return; }
      var horizonVal = cH > 0 ? cH : 30;
      var inp = { age: age, horizon: horizonVal, monthlyExpenses: mExp, state: state, ssAge: ssA, ssMonthly: ssM, desiredLegacy: leg, accountType: acct, filing: fil, extraIncomes: exs, initialPortfolio: port, hor: parsedHor > 0 ? parsedHor : null };
      saveInputs(inp);
      props.onGen(inp);
    }

    var sOpts = Object.keys(ST).sort(function (a, b) { return ST[a].n.localeCompare(ST[b].n); }).map(function (k) { return h("option", { key: k, value: k }, ST[k].n + " (" + ST[k].r + "%)"); });

    return h("div", { className: "card" },
      h("h2", { style: { marginBottom: 4 } }, "Plan Parameters"),
      h("p", { className: "ts", style: { marginBottom: 16, color: "#444" } }, "Configure your retirement details. Changes are saved automatically."),
      h("div", { className: "fr" },
        h("div", { className: "fg" }, h("label", { className: "fl" }, "Current Age"), h("input", { type: "number", className: "fi", value: age, onChange: function (e) { sA(Number(e.target.value) || 0); }, min: 25, max: 90 })),
        h("div", { className: "fg" }, h("label", { className: "fl" }, "Horizon (years)"), h("input", { type: "number", className: "fi", value: hor, onChange: function (e) { sH(e.target.value); }, placeholder: cH + " (life exp.)", min: 1, max: 60 }))),
      h("div", { className: "fr" },
        h("div", { className: "fg" }, h("label", { className: "fl" }, "Portfolio Value ($)"), h("input", { type: "number", className: "fi", value: port, onChange: function (e) { sP(Number(e.target.value) || 0); }, min: 0, step: 10000 })),
        h("div", { className: "fg" }, h("label", { className: "fl" }, "Monthly Expenses ($)"), h("input", { type: "number", className: "fi", value: mExp, onChange: function (e) { sE(Number(e.target.value) || 0); }, min: 0, step: 100 }))),
      h("div", { className: "fr" },
        h("div", { className: "fg" }, h("label", { className: "fl" }, "State"), h("select", { className: "fi", value: state, onChange: function (e) { sSt(e.target.value); } }, sOpts)),
        h("div", { className: "fg" }, h("label", { className: "fl" }, "Filing Status"), h("select", { className: "fi", value: fil, onChange: function (e) { sF(e.target.value); } }, h("option", { value: "single" }, "Single"), h("option", { value: "married" }, "Married Filing Jointly")))),
      h("div", { className: "fr" },
        h("div", { className: "fg" }, h("label", { className: "fl" }, "SS Start Age"), h("select", { className: "fi", value: ssA, onChange: function (e) { sSA(Number(e.target.value) || 62); } }, [62, 63, 64, 65, 66, 67, 68, 69, 70].map(function (a) { return h("option", { key: a, value: a }, a); }))),
        h("div", { className: "fg" }, h("label", { className: "fl" }, "SS Monthly ($)"), h("input", { type: "number", className: "fi", value: ssM, onChange: function (e) { sSM(Number(e.target.value) || 0); }, min: 0, step: 100 }))),
      h("div", { className: "fr" },
        h("div", { className: "fg" }, h("label", { className: "fl" }, "Account Type"), h("select", { className: "fi", value: acct, onChange: function (e) { sAT(e.target.value); } }, h("option", { value: "traditional" }, "Traditional IRA/401(k)"), h("option", { value: "roth" }, "Roth IRA/401(k)"), h("option", { value: "taxable" }, "Taxable Brokerage"))),
        h("div", { className: "fg" }, h("label", { className: "fl" }, "Legacy Value ($)"), h("input", { type: "number", className: "fi", value: leg, onChange: function (e) { sL(Number(e.target.value) || 0); }, min: 0, step: 10000 }))),
      h("div", { className: "dv" }),
      h("div", { style: { display: "flex", alignItems: "center", justifyContent: "space-between", marginBottom: 12, flexWrap: "wrap" } },
        h("h3", { style: { margin: "4px 0" } }, "Additional Income"), h("button", { className: "btn btn2 btns", style: { margin: "4px 0" }, onClick: addE }, "+ Add Income")),
      exs.map(function (ei, i) {
        return h("div", { key: i, className: "is" },
          h("div", { className: "if" },
            h("div", { className: "fg", style: { margin: 0 } }, h("label", { className: "fl" }, "Label"), h("input", { className: "fi", value: ei.label, onChange: function (e) { upE(i, "label", e.target.value); } })),
            h("div", { className: "fg", style: { margin: 0 } }, h("label", { className: "fl" }, "$/Mo"), h("input", { type: "number", className: "fi", value: ei.monthly, onChange: function (e) { upE(i, "monthly", e.target.value); }, min: 0 })),
            h("div", { className: "fg", style: { margin: 0 } }, h("label", { className: "fl" }, "Start"), h("input", { type: "number", className: "fi", value: ei.startAge, onChange: function (e) { upE(i, "startAge", e.target.value); } })),
            h("div", { className: "fg", style: { margin: 0 } }, h("label", { className: "fl" }, "End"), h("input", { type: "number", className: "fi", value: ei.endAge, onChange: function (e) { upE(i, "endAge", e.target.value); } }))),
          h("button", { style: { background: "none", border: "none", color: "#c0392b", cursor: "pointer", fontSize: "1.2rem", padding: "4px 8px" }, onClick: function () { rmE(i); } }, "\u2715"));
      }),
      h("div", { style: { marginTop: 20 } }, h("button", { className: "btn btn1", onClick: function () { go(false); }, style: { width: "100%", padding: "14px 24px", fontSize: "1rem" } }, props.gen ? "Generating plan..." : "Generate Retirement Plan")));
  }

  /* --- Results --- */
  function Results(props) {
    var plan = props.plan; var inp = plan.inputs;
    var _s = useState("average"); var sc = _s[0]; var setSc = _s[1];
    var _m = useState(null); var modal = _m[0]; var setM = _m[1];
    var _sa = useState(false); var showAll = _sa[0]; var setSA = _sa[1];
    var _st = useState(false); var showTxn = _st[0]; var setST = _st[1];
    var pr = useRef(null);
    var d = plan.results[sc]; var last = d[d.length - 1];
    var depI = -1; for (var di = 0; di < d.length; di++) { if (d[di].port <= 0) { depI = di; break; } }
    var dep = depI >= 0;
    var summ = ["best", "average", "worst", "recession"].map(function (s) {
      var dd = plan.results[s]; var l = dd[dd.length - 1];
      var dpi = -1; for (var j = 0; j < dd.length; j++) { if (dd[j].port <= 0) { dpi = j; break; } }
      return { s: s, fv: l ? l.port : 0, dep: dpi >= 0, da: dpi >= 0 ? dd[dpi].age : null };
    });
    var etfKeys = Object.keys(plan.ie).filter(function (k) { return plan.ie[k] > 0.005; }).sort(function (a, b) { return plan.ie[b] - plan.ie[a]; });
    var rbc = { "Very Low": "bg", "Low": "bg", "Low-Moderate": "bb", "Moderate": "ba", "Moderate-High": "br", "High": "br" };
    var displayYrs = showAll ? d : d.filter(function (y, i) { return i < 5 || i >= d.length - 3 || i % 5 === 0; });
    var totFedTax = 0; var totStTax = 0; var totInc = 0;
    for (var i = 0; i < d.length; i++) { totFedTax += d[i].fTax; totStTax += d[i].sTax; totInc += d[i].totInc; }
    var totTax = totFedTax + totStTax;
    var ssRec = inp.ssAge < 67 ? "Claiming SS early reduces your benefit. Each year you delay (up to 70) increases it ~8%." : inp.ssAge >= 70 ? "Claiming at 70 maximizes your benefit." : "Claiming at full retirement age is a balanced approach.";
    var txRec = inp.accountType === "traditional" ? "Consider Roth conversions in low-income years." : inp.accountType === "roth" ? "Roth withdrawals are tax-free. Extra income is still taxable." : "Hold assets >1yr for long-term capital gains rates.";

    var actCfg = useMemo(function () {
      var dd = plan.results[sc]; var cl = { average: "#2d5a3d", best: "#10b981", worst: "#c0392b", recession: "#f59e0b" };
      return { type: "line", data: { labels: dd.map(function (y) { return y.age; }), datasets: [{ label: "Portfolio", data: dd.map(function (y) { return y.port; }), borderColor: cl[sc], backgroundColor: cl[sc] + "15", fill: true, borderWidth: 2.5, pointRadius: 0, tension: 0.3 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, tooltip: { callbacks: { label: function (c) { return fmt(c.parsed.y); } } } }, scales: { y: { ticks: { callback: function (v) { return fmt(v); }, font: { size: 10 } }, grid: { color: "#ddd9d3" } }, x: { title: { display: true, text: "Age", font: { size: 11 } }, ticks: { font: { size: 10 }, maxTicksLimit: 15 }, grid: { display: false } } } } };
    }, [plan, sc]);

    var incCfg = useMemo(function () {
      var dd = plan.results[sc];
      return { type: "bar", data: { labels: dd.map(function (y) { return y.age; }), datasets: [{ label: "Social Security", data: dd.map(function (y) { return y.ss; }), backgroundColor: "#3b82f6" }, { label: "Dividends", data: dd.map(function (y) { return y.div; }), backgroundColor: "#10b981" }, { label: "Extra Income", data: dd.map(function (y) { return y.extra; }), backgroundColor: "#f59e0b" }, { label: "Withdrawal", data: dd.map(function (y) { return y.wd; }), backgroundColor: "rgba(192,57,43,0.7)" }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: "bottom", labels: { font: { size: 11 } } }, tooltip: { callbacks: { label: function (c) { return c.dataset.label + ": " + fmt(c.parsed.y); } } } }, scales: { x: { stacked: true, ticks: { font: { size: 10 }, maxTicksLimit: 15 }, grid: { display: false } }, y: { stacked: true, ticks: { callback: function (v) { return fmt(v); }, font: { size: 10 } }, grid: { color: "#ddd9d3" } } } } };
    }, [plan, sc]);

    var allocCfg = useMemo(function () {
      var dd = plan.results.average;
      var cats = ["growth", "value", "dividend", "intl", "reit", "bond", "tips", "shortBond", "cash"];
      var cn = ["Growth", "Value", "Dividend", "Intl", "REITs", "Bonds", "TIPS", "Short Bonds", "Cash"];
      var cc = ["#8b5cf6", "#6366f1", "#10b981", "#f59e0b", "#f97316", "#64748b", "#0ea5e9", "#06b6d4", "#84cc16"];
      return { type: "line", data: { labels: dd.map(function (y) { return y.age; }), datasets: cats.map(function (c, i) { return { label: cn[i], data: dd.map(function (y) { return Math.round(y.alloc[c] * 1000) / 10; }), backgroundColor: cc[i] + "cc", borderColor: cc[i], fill: true, borderWidth: 1, pointRadius: 0, tension: 0.3 }; }) }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: "bottom", labels: { font: { size: 10 } } }, tooltip: { callbacks: { label: function (c) { return c.dataset.label + ": " + c.parsed.y.toFixed(1) + "%"; } } } }, scales: { x: { ticks: { font: { size: 10 }, maxTicksLimit: 15 }, grid: { display: false } }, y: { stacked: true, max: 100, ticks: { callback: function (v) { return v + "%"; }, font: { size: 10 } }, grid: { color: "#ddd9d3" } } } } };
    }, [plan]);

    function exportPDF() {
      if (typeof html2canvas === "undefined" || typeof jspdf === "undefined") {
        var s1 = document.createElement("script"); s1.src = "https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js";
        var s2 = document.createElement("script"); s2.src = "https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js";
        s1.onload = function () { document.head.appendChild(s2); };
        s2.onload = function () { doExport(); };
        document.head.appendChild(s1);
      } else { doExport(); }
      function doExport() {
        var el = pr.current; if (!el) return;
        html2canvas(el, { scale: 1.5, useCORS: true, backgroundColor: "#faf8f6", windowWidth: 1000 }).then(function (canvas) {
          var img = canvas.toDataURL("image/jpeg", 0.8);
          var pdf = new jspdf.jsPDF("p", "mm", "a4");
          var pw = pdf.internal.pageSize.getWidth() - 20;
          var ph = pdf.internal.pageSize.getHeight() - 20;
          var iw = pw; var ih = canvas.height * iw / canvas.width; var pos = 0; var hl = ih;
          pdf.addImage(img, "JPEG", 10, 10, iw, ih); hl -= ph;
          while (hl > 0) { pos -= ph; pdf.addPage(); pdf.addImage(img, "JPEG", 10, pos + 10, iw, ih); hl -= ph; }
          pdf.save("retirement-plan.pdf");
        })["catch"](function (e) { alert("PDF error: " + e.message); });
      }
    }

    var txnDisplay = showTxn ? plan.txns : plan.txns.filter(function (t, i) { return i === 0 || i % 5 === 0 || i === plan.txns.length - 1; });

    return h("div", { ref: pr },
      modal ? h(EModal, { tk: modal, onClose: function () { setM(null); } }) : null,

      h("div", { className: "card" },
        h("div", { className: "card-hdr" }, h("h2", null, "Plan Summary"), h("button", { className: "btn btn2 btns np", onClick: exportPDF }, "Export PDF")),
        h("div", { className: "g4" },
          h("div", { className: "sc" }, h("div", { className: "sl" }, "Starting Portfolio"), h("div", { className: "sv" }, fmt(inp.initialPortfolio))),
          h("div", { className: "sc" }, h("div", { className: "sl" }, "Horizon"), h("div", { className: "sv" }, inp.horizon + " yrs"), h("div", { className: "ts", style: { color: "#777" } }, "Age " + inp.age + " to " + (inp.age + inp.horizon))),
          h("div", { className: "sc" }, h("div", { className: "sl" }, "Monthly Expenses"), h("div", { className: "sv" }, fmt(inp.monthlyExpenses))),
          h("div", { className: "sc" }, h("div", { className: "sl" }, "Account"), h("div", { className: "sv", style: { fontSize: "1rem", textTransform: "capitalize" } }, inp.accountType))),
        h("div", { className: "dv" }),
        h("h3", null, "Initial Allocation"),
        h("p", { className: "ts", style: { marginBottom: 8, color: "#444" } }, "Starting positions. Click any ticker for ETF details."),
        h("div", { className: "tw" }, h("table", null,
          h("thead", null, h("tr", null, h("th", null, "Ticker"), h("th", null, "Fund Name"), h("th", { className: "tr" }, "Alloc %"), h("th", { className: "tr" }, "Amount"), h("th", { className: "tr" }, "Yield"), h("th", { className: "tc" }, "Risk"))),
          h("tbody", null, etfKeys.map(function (tk) { var e = ETFS[tk]; if (!e) return null; var pct = plan.ie[tk] * 100; var amt = Math.round(inp.initialPortfolio * plan.ie[tk]);
            return h("tr", { key: tk, style: { cursor: "pointer" }, onClick: function () { setM(tk); } },
              h("td", null, h("span", { style: { fontWeight: 700, color: EC[tk] } }, tk)),
              h("td", { className: "ts" }, e.nm), h("td", { className: "tr" }, pct.toFixed(1) + "%"),
              h("td", { className: "tr", style: { fontWeight: 600 } }, fmt(amt)), h("td", { className: "tr" }, e.dy + "%"),
              h("td", { className: "tc" }, h("span", { className: "badge " + (rbc[e.risk] || "") }, e.risk))); })))),
        h("div", { className: "dv" }),
        h("h3", null, "Scenario Outcomes"),
        h("div", { className: "tw", style: { marginTop: 8 } }, h("table", null,
          h("thead", null, h("tr", null, h("th", null, "Scenario"), h("th", { className: "tr" }, "Final Value"), h("th", { className: "tc" }, "Funds Last?"), h("th", { className: "tc" }, "Legacy Met?"))),
          h("tbody", null, summ.map(function (s) { return h("tr", { key: s.s }, h("td", { style: { textTransform: "capitalize", fontWeight: 600 } }, s.s), h("td", { className: "tr " + (s.fv > 0 ? "tg" : "trd") }, fmt(s.fv)), h("td", { className: "tc" }, s.dep ? h("span", { className: "badge br" }, "Depletes " + s.da) : h("span", { className: "badge bg" }, "Yes")), h("td", { className: "tc" }, s.fv >= inp.desiredLegacy ? h("span", { className: "badge bg" }, "Yes") : h("span", { className: "badge ba" }, "No"))); })))),
        dep && sc !== "best" ? h("div", { className: "ab abd" }, h("strong", { style: { color: "#c0392b" } }, "Portfolio Depletion Warning"), h("p", { className: "ts", style: { marginTop: 4, color: "#c0392b" } }, "In the " + sc + " scenario, funds run out at age " + d[depI].age + ".")) : null,
        !dep && last && last.port > inp.desiredLegacy * 1.5 && sc === "average" ? h("div", { className: "ab abs" }, h("strong", { style: { color: "#257a45" } }, "Strong Position"), h("p", { className: "ts", style: { marginTop: 4, color: "#257a45" } }, "Projects " + fmt(last.port) + " remaining at age " + (inp.age + inp.horizon) + ".")) : null,
        h("div", { className: "dv" }),
        h("h3", null, "Drawdown Strategy"),
        h("p", { className: "ts", style: { marginBottom: 10, color: "#444" } }, "Assets liquidated from most conservative to most aggressive:"),
        h("div", { style: { display: "flex", flexWrap: "wrap", marginBottom: 12, alignItems: "center" } }, LIQ.map(function (t, i) { return h(React.Fragment, { key: t }, h("span", { className: "ec", onClick: function () { setM(t); } }, h("span", { style: { width: 8, height: 8, borderRadius: "50%", backgroundColor: EC[t], display: "inline-block", marginRight: 4 } }), " " + t), i < LIQ.length - 1 ? h("span", { style: { color: "#777", fontSize: ".8rem", margin: "0 2px" } }, " \u2192 ") : null); })),
        h("div", { className: "rg", style: { marginTop: 4 } },
          h("div", null, h("strong", { className: "ts" }, "Early (Yr 1-5)"), h("p", { className: "ts", style: { color: "#444" } }, "Draw from cash (SHV) and short bonds (VGSH).")),
          h("div", null, h("strong", { className: "ts" }, "Mid (Yr 6-15)"), h("p", { className: "ts", style: { color: "#444" } }, "Draw from core bonds (BND) and TIPS.")),
          h("div", null, h("strong", { className: "ts" }, "Late (Yr 16+)"), h("p", { className: "ts", style: { color: "#444" } }, "SS fully active. Draw from dividend/value ETFs.")),
          h("div", null, h("strong", { className: "ts" }, "Recession"), h("p", { className: "ts", style: { color: "#444" } }, "Prioritize bonds/cash to avoid selling equities at lows."))),
        h("div", { className: "dv" }),
        h(Coll, { title: "Key Recommendations", open: true },
          h("div", { className: "rg" },
            h("div", null, h("strong", null, "Cash Buffer"), h("p", { className: "ts", style: { color: "#444" } }, "Maintain " + fmt(inp.monthlyExpenses * 6) + " to " + fmt(inp.monthlyExpenses * 12) + " in cash.")),
            h("div", null, h("strong", null, "Social Security"), h("p", { className: "ts", style: { color: "#444" } }, ssRec)),
            h("div", null, h("strong", null, "Rebalancing"), h("p", { className: "ts", style: { color: "#444" } }, "Rebalance annually to match target allocation.")),
            h("div", null, h("strong", null, "Tax Strategy"), h("p", { className: "ts", style: { color: "#444" } }, txRec))))
      ),

      h("div", { className: "np", style: { display: "flex", alignItems: "center", marginBottom: 16, flexWrap: "wrap" } },
        h("span", { className: "ts", style: { fontWeight: 600, marginRight: 12 } }, "View scenario:"),
        h("div", { className: "stabs" }, ["average", "best", "worst", "recession"].map(function (s) { return h("button", { key: s, className: "stab" + (sc === s ? " act" : ""), onClick: function () { setSc(s); }, style: { textTransform: "capitalize" } }, s); }))),

      h("div", { className: "card" }, h("h2", null, "Portfolio -- " + sc.charAt(0).toUpperCase() + sc.slice(1)), h(CC, { cfg: actCfg, ht: 280, key: "p-" + sc })),
      h("div", { className: "card" }, h("h2", null, "Allocation Glide Path"), h("p", { className: "ts", style: { marginBottom: 8, color: "#444" } }, "How allocation shifts from growth to income over your horizon."), h(CC, { cfg: allocCfg, ht: 300 })),
      h("div", { className: "card" }, h("h2", null, "Annual Income Sources"), h(CC, { cfg: incCfg, ht: 300, key: "i-" + sc })),

      h("div", { className: "card" },
        h("div", { className: "card-hdr" }, h("h2", null, "Rebalancing Transactions"), h("button", { className: "btn btn2 btns np", onClick: function () { setST(!showTxn); } }, showTxn ? "Summary" : "All Years")),
        h("p", { className: "ts", style: { marginBottom: 12, color: "#444" } }, "Buy/sell actions for the glide path. Year 1 shows initial purchases."),
        h("div", { className: "tw" }, h("table", null,
          h("thead", null, h("tr", null, h("th", null, "Year"), h("th", null, "Age"), h("th", null, "Action"), h("th", null, "ETF"), h("th", { className: "tr" }, "% Chg"), h("th", { className: "tr" }, "Est. Amount"))),
          h("tbody", null, txnDisplay.map(function (row) {
            return row.actions.map(function (a, ai) {
              return h("tr", { key: row.yr + "-" + a.tk },
                h("td", { style: { fontWeight: ai === 0 ? 600 : 400, color: ai === 0 ? "#111" : "transparent" } }, ai === 0 ? row.yr : ""),
                h("td", { style: { color: ai === 0 ? "#111" : "transparent" } }, ai === 0 ? row.age : ""),
                h("td", null, h("span", { className: a.type === "buy" ? "buy" : "sell" }, a.type === "buy" ? "\u25B2 Buy" : "\u25BC Sell")),
                h("td", null, h("span", { style: { fontWeight: 600, color: EC[a.tk] } }, a.tk)),
                h("td", { className: "tr" }, (a.type === "buy" ? "+" : "\u2212") + a.pct.toFixed(1) + "%"),
                h("td", { className: "tr" }, fmt(a.amt)));
            });
          })))),
        !showTxn && plan.txns.length > 5 ? h("p", { className: "ts", style: { textAlign: "center", marginTop: 8, color: "#777" } }, "Showing key years. Click \"All Years\" for complete schedule.") : null),

      h("div", { className: "card" },
        h("div", { className: "card-hdr" }, h("h2", null, "Year-by-Year Details"), h("button", { className: "btn btn2 btns np", onClick: function () { setSA(!showAll); } }, showAll ? "Summary" : "All Years")),
        h("p", { className: "ts", style: { marginBottom: 8, color: "#444" } }, "Withdrawals only occur when income cannot cover expenses + taxes."),
        h("div", { className: "tw" }, h("table", null,
          h("thead", null, h("tr", null, h("th", null, "Age"), h("th", { className: "tr" }, "Portfolio"), h("th", { className: "tr" }, "Expenses"), h("th", { className: "tr" }, "SS"), h("th", { className: "tr" }, "Div."), h("th", { className: "tr" }, "Extra"), h("th", { className: "tr" }, "Wdraw"), h("th", { className: "tr" }, "Fed Tax"), h("th", { className: "tr" }, "St Tax"), h("th", { className: "tr" }, "Net"))),
          h("tbody", null, displayYrs.map(function (y) { return h("tr", { key: y.yr, style: y.port <= 0 ? { backgroundColor: "#fce8e6" } : {} },
            h("td", { style: { fontWeight: 600 } }, y.age),
            h("td", { className: "tr " + (y.port > 0 ? "" : "trd") }, fmt(y.port)),
            h("td", { className: "tr" }, fmt(y.exp)),
            h("td", { className: "tr" }, y.ss > 0 ? fmt(y.ss) : "--"),
            h("td", { className: "tr tg" }, fmt(y.div)),
            h("td", { className: "tr" }, y.extra > 0 ? fmt(y.extra) : "--"),
            h("td", { className: "tr ta" }, fmt(y.wd)),
            h("td", { className: "tr trd" }, fmt(y.fTax)),
            h("td", { className: "tr trd" }, fmt(y.sTax)),
            h("td", { className: "tr", style: { fontWeight: 600, color: y.net >= 0 ? "#257a45" : "#c0392b" } }, fmt(y.net))); })))),
        h("p", { className: "ts", style: { marginTop: 8, color: "#777" } }, "Net = Dividends + Withdrawals + SS + Extra - Expenses - Taxes")),

      h("div", { className: "card" },
        h("h2", null, "ETF Reference"),
        h("p", { className: "ts", style: { marginBottom: 16, color: "#444" } }, "Click any row for details."),
        h("div", { className: "tw" }, h("table", null,
          h("thead", null, h("tr", null, h("th", null, "ETF"), h("th", null, "Category"), h("th", { className: "tr" }, "Alloc"), h("th", { className: "tr" }, "Amount"), h("th", { className: "tr" }, "Yield"), h("th", { className: "tr" }, "ER"), h("th", { className: "tc" }, "Risk"), h("th", { className: "tr" }, "10Y"))),
          h("tbody", null, etfKeys.map(function (tk) { var e = ETFS[tk]; if (!e) return null; return h("tr", { key: tk, style: { cursor: "pointer" }, onClick: function () { setM(tk); } },
            h("td", null, h("span", { style: { fontWeight: 700, color: EC[tk] } }, tk)),
            h("td", { className: "ts" }, e.cat), h("td", { className: "tr" }, (plan.ie[tk] * 100).toFixed(1) + "%"),
            h("td", { className: "tr" }, fmt(Math.round(inp.initialPortfolio * plan.ie[tk]))),
            h("td", { className: "tr" }, e.dy + "%"), h("td", { className: "tr" }, e.er + "%"),
            h("td", { className: "tc" }, h("span", { className: "badge " + (rbc[e.risk] || "") }, e.risk)),
            h("td", { className: "tr tg" }, "+" + e.ret.y10 + "%")); }))))),

      h("div", { className: "card" },
        h("h2", null, "Tax Summary"),
        h("div", { className: "g3" },
          h("div", { className: "sc" }, h("div", { className: "sl" }, "Total Federal Tax"), h("div", { className: "sv trd" }, fmt(totFedTax))),
          h("div", { className: "sc" }, h("div", { className: "sl" }, "Total State Tax (" + (ST[inp.state] ? ST[inp.state].n : inp.state) + ")"), h("div", { className: "sv trd" }, fmt(totStTax))),
          h("div", { className: "sc" }, h("div", { className: "sl" }, "Effective Rate"), h("div", { className: "sv" }, totInc > 0 ? (totTax / totInc * 100).toFixed(1) + "%" : "0%"))),
        h("p", { className: "ts", style: { marginTop: 16, color: "#444" } }, inp.accountType === "roth" ? "Roth: withdrawals are tax-free. Extra income and SS remain taxable." : inp.accountType === "traditional" ? "Traditional: all withdrawals, dividends, extra income, and partial SS are taxable." : "Taxable: capital gains, dividends, extra income, and partial SS are taxable."))
    );
  }

  /* --- App --- */
  function App() {
    var _p = useState(null); var plan = _p[0]; var sP = _p[1];
    var _g = useState(false); var gen = _g[0]; var sG = _g[1];
    var rr = useRef(null);
    function onGen(inp) {
      sG(true);
      setTimeout(function () { sP(calcPlan(inp)); sG(false);
        setTimeout(function () { if (rr.current) rr.current.scrollIntoView({ behavior: "smooth" }); }, 100);
      }, 50);
    }
    return h("div", null,
      h("div", { className: "hero" },
        h("h1", null, "Retirement ", h("span", { className: "ha" }, "Account Planner")),
        h("p", null, "ETF-based investing, tax-aware projections, and scenario analysis.")),
      h("div", { className: "ctr" },
        h(Coll, { title: "How to Use This Tool" },
          h("p", { style: { color: "#444" } }, "Enter your age, portfolio, expenses, Social Security details, account type, and state. The planner generates year-by-year projections across 4 scenarios with ETF-based allocation that shifts from growth to income over time. Your inputs are saved locally."),
          h("p", { style: { marginTop: 12, fontStyle: "italic", color: "#777" } }, "For educational purposes only. Not financial advice.")),
        h("div", { style: { marginTop: 20 } }),
        h(IForm, { onGen: onGen, gen: gen }),
        plan ? h("div", { ref: rr, style: { marginTop: 24 } }, h(Results, { plan: plan })) : null,
        h("div", { style: { textAlign: "center", padding: "32px 0", color: "#777", fontSize: ".8rem" } }, "Retirement Account Planner")));
  }

  /* --- Mount --- */
  var rootEl = document.getElementById("root");
  if (ReactDOM.createRoot) {
    ReactDOM.createRoot(rootEl).render(h(App));
  } else {
    ReactDOM.render(h(App), rootEl);
  }

})();
</script>

</body>
</html>
